<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥ç§˜æª”æ¡ˆï¼šå¤±è½çš„æ–‡ç‰©</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šç¾©æ²è»¸æ¨£å¼ï¼Œè®“ä»‹é¢æ›´æœ‰åµæ¢ä¸»é¡Œæ„Ÿ */
        #case-file::-webkit-scrollbar, #clue-dossier::-webkit-scrollbar {
            width: 8px;
        }
        #case-file::-webkit-scrollbar-thumb, #clue-dossier::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* ç°è‰²èª¿ */
            border-radius: 4px;
        }
        #case-file::-webkit-scrollbar-track, #clue-dossier::-webkit-scrollbar-track {
            background: #1f2937; /* æ·±è—ç°è‰²èƒŒæ™¯ */
        }
        /* Inter å­—é«” (Tailwind é»˜èª) */
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        /* åµæ¢è¼¸å…¥æ¬„çš„ç‰¹æ®Šæ¨£å¼ */
        #action-input {
            transition: all 0.2s ease-in-out;
            outline: none;
            box-shadow: 0 0 0 2px transparent;
        }
        #action-input:focus {
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.5); /* èšç„¦æ™‚é¡¯ç¤ºé‡‘è‰²å…‰æšˆ */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'detective-bg': '#111827', /* æ·±è—ç° */
                        'case-paper': '#f3f4f6', /* æ·ºç°ç´™å¼µ */
                        'clue-text': '#1f2937', /* æ·±è‰²æ–‡å­— */
                        'accent-gold': '#fbbf24', /* é‡‘è‰²å¼·èª¿ */
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-detective-bg text-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- ä¸»éŠæˆ²å®¹å™¨ (æœ€å¤§å¯¬åº¦å¢åŠ ä»¥å®¹ç´å´é‚Šæ¬„) -->
    <div class="w-full max-w-6xl bg-gray-800 rounded-xl shadow-2xl overflow-hidden flex flex-col h-[90vh]">
        
        <!-- æ¨™é¡Œã€å„²å­˜/è¼‰å…¥æŒ‰éˆ•èˆ‡è³‡è¨Š -->
        <header class="bg-gray-900 p-4 border-b-4 border-accent-gold flex justify-between items-center">
            <h1 class="text-2xl font-bold text-accent-gold">ç¥ç§˜æª”æ¡ˆï¼šå¤±è½çš„æ–‡ç‰©</h1>
            <div class="flex items-center space-x-4">
                <!-- å„²å­˜/è¼‰å…¥æŒ‰éˆ• -->
                <button id="save-btn" onclick="saveGameState()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-200 text-sm disabled:opacity-50">
                    å„²å­˜é€²åº¦
                </button>
                <button id="load-btn" onclick="loadGameState()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-200 text-sm disabled:opacity-50">
                    è¼‰å…¥é€²åº¦
                </button>
                <!-- ä½¿ç”¨è€… ID é¡¯ç¤º -->
                <div class="text-sm font-light italic opacity-75 hidden sm:block">
                    ID: <span id="user-id" class="font-mono text-xs">è¼‰å…¥ä¸­...</span>
                </div>
            </div>
        </header>

        <!-- å…§å®¹å€: æª”æ¡ˆå¤¾èˆ‡å°è©± (ä½¿ç”¨ Grid ä½ˆå±€) -->
        <div class="flex-grow grid grid-cols-1 md:grid-cols-5 overflow-hidden">
            
            <!-- æª”æ¡ˆå¤¾ (Dossier) - ä½” 2/5 æˆ– 1/5 å¯¬åº¦ -->
            <div id="dossier-sidebar" class="md:col-span-2 lg:col-span-1 bg-gray-900 p-4 border-r border-gray-700 overflow-y-auto hidden md:block">
                <h2 class="text-xl font-bold text-accent-gold mb-3 border-b border-accent-gold/50 pb-2">æ¡ˆä»¶æª”æ¡ˆå¤¾</h2>
                
                <!-- Dossier å°èˆªæ¨™ç±¤ -->
                <div class="flex border-b border-gray-700 mb-3">
                    <button id="tab-clues" onclick="switchDossierView('clues')" class="flex-grow py-2 text-sm font-semibold border-b-2 border-accent-gold text-accent-gold transition-colors">
                        ç·šç´¢æª”æ¡ˆ
                    </button>
                    <button id="tab-characters" onclick="switchDossierView('characters')" class="flex-grow py-2 text-sm font-semibold border-b-2 border-transparent text-gray-400 hover:text-gray-200 transition-colors">
                        äººç‰©æª”æ¡ˆ
                    </button>
                </div>

                <div id="dossier-content" class="space-y-3">
                    <!-- Panel 1: Clues -->
                    <div id="clues-panel">
                        <div id="clues-list" class="space-y-3">
                            <p class="text-gray-400 text-sm italic">å°šç„¡é—œéµç·šç´¢è¢«è¨˜éŒ„ã€‚</p>
                        </div>
                    </div>
                    
                    <!-- Panel 2: Characters (Initially Hidden) -->
                    <div id="characters-panel" class="hidden">
                        <div id="characters-list" class="space-y-3">
                            <p class="text-gray-400 text-sm italic">å°šç„¡äººç‰©è¢«è¨˜éŒ„ã€‚</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¡ˆä»¶æª”æ¡ˆ (å°è©±/ç·šç´¢é¡¯ç¤ºå€) - ä½” 3/5 æˆ– 4/5 å¯¬åº¦ -->
            <div id="case-file" class="md:col-span-3 lg:col-span-4 flex-grow p-5 overflow-y-auto space-y-4 bg-gray-700">
                <!-- åˆå§‹æ¡ˆä»¶æè¿°å°‡åœ¨é€™è£¡é¡¯ç¤º -->
            </div>
        </div>
        
        <!-- è¼¸å…¥èˆ‡è¡Œå‹•å€ -->
        <footer class="p-4 bg-gray-900 border-t border-gray-700">
            <div class="flex space-x-3">
                <input 
                    type="text" 
                    id="action-input" 
                    placeholder="è¼¸å…¥æ‚¨çš„åµæŸ¥è¡Œå‹•ï¼Œä¾‹å¦‚ï¼šè©¢å•é¤¨é•·é—œæ–¼ä¿å…¨çš„æ’ç­æƒ…æ³"
                    class="flex-grow p-3 rounded-lg bg-gray-700 text-gray-100 border border-gray-600 focus:border-accent-gold"
                    onkeydown="if(event.key === 'Enter') document.getElementById('submit-action-btn').click()"
                >
                <button 
                    id="submit-action-btn"
                    onclick="handleAction()"
                    class="bg-accent-gold text-detective-bg font-bold py-3 px-6 rounded-lg hover:bg-yellow-500 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg"
                >
                    æäº¤è¡Œå‹•
                </button>
            </div>
            <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
            <div id="loading-indicator" class="mt-2 text-sm text-accent-gold flex items-center hidden">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-accent-gold" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Gemini æ­£åœ¨åˆ†æç·šç´¢...
            </div>
        </footer>

    </div>
    
    <!-- Message Toast for Save/Load Status -->
    <div id="message-toast" class="fixed bottom-4 right-4 bg-gray-900 text-white p-3 rounded-lg shadow-2xl transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <!-- Message content goes here -->
    </div>
    
    <script type="module">
        // -----------------------------------------------------
        // 1. Firebase å’Œ Auth/Firestore è¨­å®š
        // -----------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let db, auth, userId;
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // åƒ…åœ¨é…ç½®å­˜åœ¨æ™‚åˆå§‹åŒ– Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app); // åˆå§‹åŒ– Firestore
            
            // è™•ç†ç™»å…¥
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken).catch(err => {
                    console.error("Custom token sign-in failed, signing in anonymously:", err);
                    signInAnonymously(auth);
                });
            } else {
                signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id').textContent = userId.substring(0, 8) + '...';
                } else {
                    // åŒ¿åæˆ–æœªç™»å…¥
                    userId = 'anonymous-' + crypto.randomUUID().substring(0, 8);
                    document.getElementById('user-id').textContent = userId;
                }
                if (!initialStateLoaded) {
                    // èªè­‰å®Œæˆå¾Œï¼Œå˜—è©¦è¼‰å…¥å­˜æª”
                    window.loadGameState(); 
                }
            });
        } else {
            // å¦‚æœæ²’æœ‰ Firebase é…ç½®ï¼Œä½¿ç”¨ä¸€å€‹éš¨æ©Ÿ ID
            userId = 'standalone-' + crypto.randomUUID().substring(0, 8);
            document.getElementById('user-id').textContent = userId;
            window.startNewGame(); // ç›´æ¥å•Ÿå‹•æ–°éŠæˆ²
        }
        
        let initialStateLoaded = false;

        // -----------------------------------------------------
        // 2. éŠæˆ²ä¸»æ§ (Gemini API) ç›¸é—œé‚è¼¯
        // -----------------------------------------------------

        const MODEL_NAME = "gemini-2.5-flash-preview-05-20";
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
        
        // **æ›´æ–°çš„ System Prompt**ï¼šæ–°å¢äº†äººç‰© JSON çµæ§‹æŒ‡ä»¤
        const systemPrompt = `
            æ‚¨æ˜¯åµæ¢è§£è¬éŠæˆ²ã€Œç¥ç§˜æª”æ¡ˆï¼šå¤±è½çš„æ–‡ç‰©ã€çš„**éŠæˆ²ä¸»æ§ï¼ˆGame Masterï¼‰**ã€‚
            æ‚¨çš„è·è²¬æ˜¯ï¼š
            1.  **æ ¹æ“šç©å®¶çš„è¡Œå‹•ï¼ˆUser Actionï¼‰ä¾†æ¨å‹•æ•…äº‹æƒ…ç¯€ã€‚**
            2.  **æä¾›è©³ç´°ã€æ°›åœæ„Ÿå¼·ã€ä¸”å……æ»¿ç·šç´¢çš„æ•˜äº‹å›æ‡‰ã€‚**
            3.  **çµ•å°ä¸èƒ½ç›´æ¥è§£æ±ºè¬åœ˜æˆ–æŒ‡å‡ºå…‡æ‰‹ã€‚**
            4.  **æ‚¨çš„å›æ‡‰å¿…é ˆåŒ…å«æ–°çš„è³‡è¨Šã€çŸ›ç›¾çš„è­‰è©ã€æˆ–æ˜¯å°ç’°å¢ƒçš„æè¿°ã€‚**
            5.  **å¤±è½çš„æ–‡ç‰©æ˜¯ã€Œæ—¥æ›œè­·èº«ç¬¦ã€ï¼ˆSunstone Amuletï¼‰ã€‚**
            6.  **æ¯ä¸€æ¬¡å›è¦†çš„ç¯‡å¹…æ‡‰åœ¨ 200 å­—ä»¥å…§ï¼Œä¿æŒç²¾ç°¡èˆ‡æ‡¸å¿µã€‚**
            7.  **ä¸€å¾‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›æ‡‰ã€‚**
            
            **[é‡è¦è¦å‰‡] çµæ§‹åŒ–ç·šç´¢æå ±ï¼š**
            å¦‚æœæ‚¨åœ¨æ•˜äº‹ä¸­æ­ç¤ºäº†æ–°çš„**é—œéµç·šç´¢**ï¼Œæ‚¨å¿…é ˆåœ¨æ‚¨çš„å›è¦†**æ–‡å­—çµæŸå¾Œ**ï¼Œé™„å¸¶ä¸€å€‹ç‰¹æ®Šçš„ JSON çµæ§‹ä¾†æå ±ç·šç´¢ã€‚
            è©² JSON å¿…é ˆè¢«ä»¥ä¸‹æ¨™ç±¤åŒ…è£¹ï¼š[CLUE_JSON_START] å’Œ [CLUE_JSON_END]ã€‚
            **ç·šç´¢é¡å‹ (type) åªèƒ½æ˜¯ï¼š** "è­‰è©"ã€"ç‰©å“"ã€"åœ°é»"ã€"æ–‡ä»¶"ã€‚

            **[é‡è¦è¦å‰‡] çµæ§‹åŒ–äººç‰©æå ±ï¼š**
            å¦‚æœæ‚¨åœ¨æ•˜äº‹ä¸­ä»‹ç´¹äº†æ–°çš„**äººç‰©æˆ–å«Œç–‘çŠ¯**ï¼Œæ‚¨å¿…é ˆåœ¨å›è¦†**æ–‡å­—çµæŸå¾Œ**ï¼Œé™„å¸¶ä¸€å€‹ç‰¹æ®Šçš„ JSON çµæ§‹ä¾†æå ±äººç‰©ã€‚
            è©² JSON å¿…é ˆè¢«ä»¥ä¸‹æ¨™ç±¤åŒ…è£¹ï¼š[CHAR_JSON_START] å’Œ [CHAR_JSON_END]ã€‚
            
            **äººç‰© JSON æ ¼å¼ç¯„ä¾‹ï¼š**
            [CHAR_JSON_START]
            {
              "name": "ç¾…ä¼¯ç‰¹Â·æ ¼é›·",
              "role": "åšç‰©é¤¨é¤¨é•·",
              "description": "ä¸€ä½å¹´é‚ä½†åš´è¬¹çš„å­¸è€…ï¼Œè² è²¬ç®¡ç†æ•´å€‹åšç‰©é¤¨ã€‚å°ã€Œæ—¥æ›œè­·èº«ç¬¦ã€æœ‰è‘—æ¥µæ·±çš„æ„Ÿæƒ…ã€‚"
            }
            [CHAR_JSON_END]
            
            è«‹åœ¨å–®æ¬¡å›è¦†ä¸­ï¼Œå…ˆæ•˜äº‹ï¼Œç„¶å¾Œä¾åºé™„å¸¶ CLUE JSON å’Œ/æˆ– CHAR JSONã€‚
        `;

        let chatHistory = [];
        let clues = []; 
        let characters = []; // æ–°å¢äººç‰©é™£åˆ—
        
        async function getGeminiResponse(prompt) {
            const maxRetries = 5;
            let currentRetry = 0;

            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = {
                contents: chatHistory,
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            while (currentRetry < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        const delay = Math.pow(2, currentRetry) * 1000 + Math.random() * 1000;
                        console.warn(`Rate limit exceeded, retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        currentRetry++;
                        continue;
                    }

                    if (!response.ok) {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        let fullResponseText = candidate.content.parts[0].text;
                        let narrativeText = fullResponseText;
                        
                        // --- 1. æå–ä¸¦è™•ç† JSON ---
                        const jsonTags = [
                            { start: '[CLUE_JSON_START]', end: '[CLUE_JSON_END]', handler: addClue },
                            { start: '[CHAR_JSON_START]', end: '[CHAR_JSON_END]', handler: addCharacter }
                        ];

                        // ç”±æ–¼ Gemini å¯èƒ½æœƒè¼¸å‡ºå¤šå€‹ JSON å€å¡Šï¼Œæˆ‘å€‘ä½¿ç”¨æ­£è¦è¡¨é”å¼ä¾†æ‰¾å°‹æ‰€æœ‰åŒ¹é…
                        for (const tag of jsonTags) {
                            const regex = new RegExp(`${tag.start}([\\s\\S]*?)${tag.end}`, 'g');
                            let match;

                            while ((match = regex.exec(fullResponseText)) !== null) {
                                const jsonString = match[1].trim();
                                try {
                                    const data = JSON.parse(jsonString);
                                    tag.handler(data);
                                    // å¾æ•˜äº‹æ–‡æœ¬ä¸­ç§»é™¤é€™å€‹ JSON å€å¡Š
                                    narrativeText = narrativeText.replace(match[0], '').trim();
                                } catch (e) {
                                    console.error(`Failed to parse ${tag.start} JSON:`, e, jsonString);
                                }
                            }
                        }
                        
                        // --- 2. æ›´æ–°èŠå¤©ç´€éŒ„ ---
                        chatHistory.push({ role: "model", parts: [{ text: narrativeText }] });
                        return narrativeText;

                    } else {
                        throw new Error("Invalid response structure from API.");
                    }
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    return "æª”æ¡ˆæå£... éŠæˆ²ä¸»æ§ä¼¼ä¹ç¶²è·¯é€£ç·šå‡ºç¾å•é¡Œã€‚è«‹ç¨å¾Œå†è©¦ã€‚";
                }
            }
            return "ç„¡æ³•é€£ç·šè‡³ç¸½éƒ¨ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šã€‚";
        }

        // -----------------------------------------------------
        // 3. éŠæˆ² UI/UX é‚è¼¯èˆ‡ç‹€æ…‹ç®¡ç†
        // -----------------------------------------------------

        const caseFile = document.getElementById('case-file');
        const actionInput = document.getElementById('action-input');
        const submitBtn = document.getElementById('submit-action-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const cluesList = document.getElementById('clues-list'); 
        const charactersList = document.getElementById('characters-list'); // æ–°å¢äººç‰©åˆ—è¡¨å…ƒç´ 
        let currentDossierView = 'clues'; // é è¨­é¡¯ç¤ºç·šç´¢

        // é¡¯ç¤ºé€šçŸ¥è¨Šæ¯
        function showToast(message, type = 'info') {
            const toast = document.getElementById('message-toast');
            let color = 'bg-gray-900';
            if (type === 'success') color = 'bg-green-600';
            if (type === 'error') color = 'bg-red-600';
            
            toast.className = `fixed bottom-4 right-4 ${color} text-white p-3 rounded-lg shadow-2xl transition-opacity duration-300 opacity-100 z-50`;
            toast.textContent = message;
            
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
            }, 3000);
        }

        // è™•ç†ç©å®¶è¡Œå‹•
        window.handleAction = async function() {
            const playerAction = actionInput.value.trim();
            if (!playerAction) return;

            // åˆå§‹è¡Œå‹•æ™‚ï¼Œå¦‚æœ chatHistory æ˜¯ç©ºçš„ï¼Œç¢ºä¿åŠ å…¥ä¸€æ¢é—œæ–¼é¤¨é•·çš„äººç‰©ç·šç´¢ (å¦‚æœæ²’æœ‰ Firebase è¼‰å…¥)
            if (chatHistory.length === 0 && !characters.some(c => c.role === 'åšç‰©é¤¨é¤¨é•·')) {
                addCharacter({
                    name: "ç¾…ä¼¯ç‰¹Â·æ ¼é›·",
                    role: "åšç‰©é¤¨é¤¨é•·",
                    description: "ä¸€ä½å¹´é‚ä½†åš´è¬¹çš„å­¸è€…ï¼Œè² è²¬ç®¡ç†æ•´å€‹åšç‰©é¤¨ã€‚å°ã€Œæ—¥æ›œè­·èº«ç¬¦ã€æœ‰è‘—æ¥µæ·±çš„æ„Ÿæƒ…ã€‚"
                });
            }

            appendMessage('player', playerAction);
            actionInput.value = ''; 
            
            setLoadingState(true);

            const gameMasterResponse = await getGeminiResponse(playerAction);

            appendMessage('game-master', gameMasterResponse);

            setLoadingState(false);
            
            // æ¯æ¬¡æˆåŠŸè¡Œå‹•å¾Œï¼Œè‡ªå‹•å„²å­˜é€²åº¦
            await window.saveGameState(); 
        }

        function setLoadingState(isLoading) {
            submitBtn.disabled = isLoading;
            actionInput.disabled = isLoading;
            loadingIndicator.classList.toggle('hidden', !isLoading);
            document.getElementById('save-btn').disabled = isLoading;
            document.getElementById('load-btn').disabled = isLoading;
        }

        // æ¸²æŸ“éœæ…‹çš„æ¡ˆä»¶ç°¡å ±å…§å®¹
        function renderInitialBriefing() {
            const initialStory = `
                <div class="text-lg text-center font-serif text-accent-gold mb-6">
                    ğŸš¨ æ¡ˆä»¶ä»£è™Ÿï¼šæ—¥æ›œé™°å½± ğŸš¨
                </div>
                <div class="bg-gray-900 p-6 rounded-xl shadow-inner border border-gray-600 text-gray-200">
                    <p class="font-bold mb-3 text-xl border-b pb-2 border-accent-gold/50">æ¡ˆä»¶ç°¡å ±ï¼š</p>
                    <p class="mb-4">
                        æ™‚å€¼æ·±å¤œï¼Œå¤§éƒ½æœƒåšç‰©é¤¨æœ€çè²´çš„è—å“â€”â€”å‚³èªªä¸­çš„**ã€Œæ—¥æ›œè­·èº«ç¬¦ã€ï¼ˆSunstone Amuletï¼‰**ä¸ç¿¼è€Œé£›ã€‚ç¾å ´æ²’æœ‰å¼·è¡Œé—–å…¥çš„ç—•è·¡ï¼Œè­¦å ±ç³»çµ±å»åœ¨åˆå¤œ 03:33 æ™‚è«åå¤±éˆäº†ä¸‰åˆ†é˜ã€‚
                    </p>
                    <p class="mb-4">
                        æ‚¨ï¼Œä¸€ä½è²åé æ’­çš„ç§å®¶åµæ¢ï¼Œè¢«é¤¨æ–¹ç·Šæ€¥å¬ä¾†ã€‚æ‚¨ç«™åœ¨ç©ºè•©è•©çš„å±•æ«ƒå‰ï¼Œç©ºæ°£ä¸­ç€°æ¼«è‘—æ˜‚è²´çš„èˆŠæœ¨é ­å’Œä¸€çµ²å¾®å¼±çš„... **æª€é¦™**æ°£å‘³ã€‚
                    </p>
                    <p class="font-bold text-accent-gold">
                        æ‚¨çš„åµæŸ¥è¡Œå‹•é–‹å§‹äº†ã€‚æ‚¨æ‰“ç®—æ€éº¼åšï¼Ÿ
                    </p>
                    <ul class="list-disc list-inside mt-3 space-y-1 text-sm text-gray-300">
                        <li>æ‚¨å¯ä»¥ï¼š**è©¢å•åœ¨å ´çš„äººç‰©** (é»æ“Šå³å´äººç‰©æª”æ¡ˆï¼Œä½ æœƒçœ‹åˆ°é¤¨é•·å·²ç¶“åœ¨å ´ï¼)</li>
                        <li>æ‚¨å¯ä»¥ï¼š**æª¢æŸ¥å±•å»³ç’°å¢ƒ** (e.g. ä»”ç´°æª¢æŸ¥å±•æ«ƒå‘¨åœçš„åœ°é¢)</li>
                        <li>æ‚¨å¯ä»¥ï¼š**æŸ¥çœ‹å®‰å…¨æ—¥èªŒ** (e.g. è¦æ±‚æŸ¥çœ‹åˆå¤œçš„ä¿å…¨å·¡é‚è¨˜éŒ„)</li>
                    </ul>
                </div>
            `;
            caseFile.innerHTML += initialStory;
        }

        // æ¸²æŸ“æ•´å€‹æ¡ˆä»¶å°è©±æª”æ¡ˆ
        function renderCaseFile() {
            caseFile.innerHTML = '';
            // 1. æ¸²æŸ“éœæ…‹çš„æ¡ˆä»¶ç°¡å ±
            renderInitialBriefing(); 

            // 2. æ¸²æŸ“æ‰€æœ‰æ­·å²è¨Šæ¯
            chatHistory.forEach(message => {
                if (message.role === 'user') {
                    appendMessage('player', message.parts[0].text, false);
                } else if (message.role === 'model') {
                    appendMessage('game-master', message.parts[0].text, false);
                }
            });
            caseFile.scrollTop = caseFile.scrollHeight;
        }


        function appendMessage(role, text, doScroll = true) {
            const messageDiv = document.createElement('div');
            
            if (role === 'game-master') {
                messageDiv.className = 'flex justify-start';
                messageDiv.innerHTML = `
                    <div class="max-w-[85%] bg-case-paper text-clue-text p-4 rounded-xl shadow-lg border-l-4 border-accent-gold whitespace-pre-wrap">
                        <p class="font-bold text-sm mb-1 text-gray-500">ã€éŠæˆ²ä¸»æ§å ±å‘Šã€‘</p>
                        ${text.replace(/\n/g, '<br>')}
                    </div>
                `;
            } else if (role === 'player') {
                messageDiv.className = 'flex justify-end';
                messageDiv.innerHTML = `
                    <div class="max-w-[85%] bg-gray-600 text-gray-50 p-3 rounded-xl shadow-md border-r-4 border-gray-400 whitespace-pre-wrap italic">
                        <p class="font-bold text-sm mb-1 text-gray-300">ã€æ‚¨çš„è¡Œå‹•ã€‘</p>
                        ${text.replace(/\n/g, '<br>')}
                    </div>
                `;
            }

            caseFile.appendChild(messageDiv);
            if (doScroll) {
                caseFile.scrollTop = caseFile.scrollHeight;
            }
        }

        // --- ç·šç´¢è™•ç† ---
        function addClue(newClue) {
            const exists = clues.some(clue => clue.text === newClue.text);
            if (!exists) {
                clues.push(newClue);
                if (currentDossierView === 'clues') renderClues();
            }
        }

        function renderClues() {
            if (clues.length === 0) {
                cluesList.innerHTML = '<p class="text-gray-400 text-sm italic">å°šç„¡é—œéµç·šç´¢è¢«è¨˜éŒ„ã€‚</p>';
                return;
            }

            cluesList.innerHTML = clues.map((clue, index) => {
                let colorClass = 'bg-gray-700 text-gray-200 border-gray-600';
                let icon = 'ğŸ“'; 

                switch(clue.type) {
                    case 'ç‰©å“':
                        colorClass = 'bg-red-900/50 text-red-200 border-red-700';
                        icon = 'ğŸ”'; 
                        break;
                    case 'è­‰è©':
                        colorClass = 'bg-blue-900/50 text-blue-200 border-blue-700';
                        icon = 'ğŸ—£ï¸'; 
                        break;
                    case 'åœ°é»':
                        colorClass = 'bg-green-900/50 text-green-200 border-green-700';
                        icon = 'ğŸ—ºï¸'; 
                        break;
                    case 'æ–‡ä»¶':
                        colorClass = 'bg-yellow-900/50 text-yellow-200 border-yellow-700';
                        icon = 'ğŸ“„'; 
                        break;
                }

                return `
                    <div class="${colorClass} p-3 rounded-lg border-l-4 shadow-md transition duration-150 ease-in-out hover:shadow-xl">
                        <p class="font-mono text-xs opacity-75 mb-1">${icon} ${clue.type}</p>
                        <p class="text-sm font-medium">${clue.text}</p>
                    </div>
                `;
            }).join('');
        }

        // --- äººç‰©è™•ç† (æ–°å¢) ---
        function addCharacter(newChar) {
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåäººç‰©
            const exists = characters.some(char => char.name === newChar.name);
            if (!exists) {
                characters.push(newChar);
                if (currentDossierView === 'characters') renderCharacters();
            }
        }

        function renderCharacters() {
            if (characters.length === 0) {
                charactersList.innerHTML = '<p class="text-gray-400 text-sm italic">å°šç„¡äººç‰©è¢«è¨˜éŒ„ã€‚</p>';
                return;
            }

            charactersList.innerHTML = characters.map(char => {
                return `
                    <div class="bg-indigo-900/50 text-white p-3 rounded-lg border-l-4 border-indigo-500 shadow-md transition duration-150 ease-in-out hover:shadow-xl">
                        <p class="font-bold text-lg">${char.name}</p>
                        <p class="text-sm font-mono text-indigo-300 mb-2">è·è²¬: ${char.role}</p>
                        <p class="text-sm">${char.description}</p>
                    </div>
                `;
            }).join('');
        }

        // --- æª”æ¡ˆå¤¾åˆ‡æ›é‚è¼¯ (æ–°å¢) ---
        window.switchDossierView = function(view) {
            currentDossierView = view;
            
            document.getElementById('clues-panel').classList.toggle('hidden', view !== 'clues');
            document.getElementById('characters-panel').classList.toggle('hidden', view !== 'characters');

            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            const clueTab = document.getElementById('tab-clues');
            const charTab = document.getElementById('tab-characters');

            if (view === 'clues') {
                clueTab.classList.replace('border-transparent', 'border-accent-gold');
                clueTab.classList.replace('text-gray-400', 'text-accent-gold');
                charTab.classList.replace('border-accent-gold', 'border-transparent');
                charTab.classList.replace('text-accent-gold', 'text-gray-400');
                renderClues(); // ç¢ºä¿åˆ‡æ›æ™‚é‡æ–°æ¸²æŸ“
            } else {
                charTab.classList.replace('border-transparent', 'border-accent-gold');
                charTab.classList.replace('text-gray-400', 'text-accent-gold');
                clueTab.classList.replace('border-accent-gold', 'border-transparent');
                clueTab.classList.replace('text-accent-gold', 'text-gray-400');
                renderCharacters(); // ç¢ºä¿åˆ‡æ›æ™‚é‡æ–°æ¸²æŸ“
            }
        }
        
        // -----------------------------------------------------
        // 4. Firestore å„²å­˜/è¼‰å…¥é‚è¼¯ (æ›´æ–°ä»¥åŒ…å« characters)
        // -----------------------------------------------------

        const GAME_COLLECTION = 'game_saves';
        const GAME_DOC_ID = 'detective_case';

        function getSaveDocRef(userId) {
            if (!db || !userId) return null;
            // ç§äººå„²å­˜è·¯å¾‘: /artifacts/{appId}/users/{userId}/game_saves/detective_case
            const path = `/artifacts/${appId}/users/${userId}/${GAME_COLLECTION}/${GAME_DOC_ID}`;
            return doc(db, path);
        }

        /**
         * å„²å­˜éŠæˆ²ç‹€æ…‹åˆ° Firestore
         */
        async function saveGameState() {
            if (!userId || !db) {
                showToast("éŒ¯èª¤ï¼šFirebase æˆ–ä½¿ç”¨è€…å°šæœªæº–å‚™å¥½ã€‚", 'error');
                return;
            }
            const saveRef = getSaveDocRef(userId);
            if (!saveRef) return;

            try {
                setLoadingState(true);
                // å°‡æ‰€æœ‰ç‹€æ…‹è³‡æ–™åºåˆ—åŒ–ç‚º JSON å­—ä¸² (åŒ…æ‹¬ characters)
                const gameState = {
                    chatHistory: chatHistory,
                    clues: clues,
                    characters: characters, // æ–°å¢
                    timestamp: Date.now()
                };
                
                await setDoc(saveRef, { state: JSON.stringify(gameState) });
                showToast("éŠæˆ²é€²åº¦å·²å„²å­˜æˆåŠŸï¼", 'success');
            } catch (error) {
                console.error("Save failed:", error);
                showToast("å„²å­˜é€²åº¦å¤±æ•—ã€‚", 'error');
            } finally {
                setLoadingState(false);
            }
        }
        window.saveGameState = saveGameState; // æš´éœ²çµ¦ HTML

        /**
         * å¾ Firestore è¼‰å…¥éŠæˆ²ç‹€æ…‹
         */
        async function loadGameState() {
            if (!userId || !db) {
                // å¦‚æœ Firebase æˆ– userId å°šæœªæº–å‚™å¥½ï¼Œåªæœƒå•Ÿå‹•æ–°éŠæˆ²
                if (!initialStateLoaded) window.startNewGame(); 
                return;
            }
            const saveRef = getSaveDocRef(userId);
            if (!saveRef) return;

            try {
                setLoadingState(true);
                const docSnap = await getDoc(saveRef);

                if (docSnap.exists() && docSnap.data().state) {
                    const loadedState = JSON.parse(docSnap.data().state);
                    
                    // è¼‰å…¥ç‹€æ…‹
                    chatHistory = loadedState.chatHistory || [];
                    clues = loadedState.clues || [];
                    characters = loadedState.characters || []; // è¼‰å…¥äººç‰©

                    // é‡æ–°æ¸²æŸ“ UI
                    renderCaseFile();
                    renderClues();
                    renderCharacters(); // æ¸²æŸ“äººç‰©
                    window.switchDossierView(currentDossierView); // ç¢ºä¿é¡¯ç¤ºæ­£ç¢ºçš„æª”æ¡ˆå¤¾
                    
                    const date = new Date(loadedState.timestamp).toLocaleTimeString('zh-TW');
                    showToast(`é€²åº¦å·²è¼‰å…¥ (ä¸Šæ¬¡å„²å­˜æ–¼ ${date})`, 'success');
                    initialStateLoaded = true;

                } else {
                    if (!initialStateLoaded) {
                        showToast("æ‰¾ä¸åˆ°å·²å„²å­˜çš„é€²åº¦ï¼Œé–‹å§‹æ–°çš„åµæŸ¥æ¡ˆä»¶ã€‚", 'info');
                        window.startNewGame();
                    }
                }
            } catch (error) {
                console.error("Load failed:", error);
                showToast("è¼‰å…¥é€²åº¦å¤±æ•—ã€‚", 'error');
                if (!initialStateLoaded) window.startNewGame();
            } finally {
                setLoadingState(false);
            }
        }
        window.loadGameState = loadGameState; // æš´éœ²çµ¦ HTML

        /**
         * å•Ÿå‹•æ–°çš„éŠæˆ²
         */
        window.startNewGame = function() {
            chatHistory = [];
            clues = [];
            characters = [];
            
            // åˆå§‹äººç‰©ï¼šé¤¨é•·
            addCharacter({
                name: "ç¾…ä¼¯ç‰¹Â·æ ¼é›·",
                role: "åšç‰©é¤¨é¤¨é•·",
                description: "ä¸€ä½å¹´é‚ä½†åš´è¬¹çš„å­¸è€…ï¼Œè² è²¬ç®¡ç†æ•´å€‹åšç‰©é¤¨ã€‚å°ã€Œæ—¥æ›œè­·èº«ç¬¦ã€æœ‰è‘—æ¥µæ·±çš„æ„Ÿæƒ…ã€‚"
            });
            
            // é‡æ–°æ¸²æŸ“ UI
            renderCaseFile(); 
            renderClues(); 
            renderCharacters();
            window.switchDossierView('clues'); // é è¨­åˆ‡æ›åˆ°ç·šç´¢

            initialStateLoaded = true;
        }

        // -----------------------------------------------------
        // 5. å•Ÿå‹•é‚è¼¯
        // -----------------------------------------------------
        // å¦‚æœæ²’æœ‰ Firebase é…ç½®ï¼Œæœƒç›´æ¥åœ¨ä¸Šæ–¹å‘¼å« startNewGameã€‚
        // å¦‚æœæœ‰ Firebaseï¼Œå‰‡æœƒåœ¨ onAuthStateChanged å®Œæˆå¾Œå‘¼å« loadGameStateã€‚
        
    </script>
</body>
</html>
